---
templateKey: blog-post
title: ğŸš• 14 ìš°ë²„ í´ë¡  ì½”ë”© (nomad coders)
date: 2019-05-02T08:56:56.243Z
description: ìš°ë²„ ì½”ë”© ê°•ì˜ ë¡œê·¸ 1.76 ~ 1.80
featuredpost: true
featuredimage: /img/nuber_clone.jpg
tags:
  - nomad coders
  - ìš°ë²„ í´ë¡  ì½”ë”©
  - graphql-yoga
---
# 

## #1.76 UpdateRideStatus Resolver part One

ì´ì „ì— Rideë¥¼ ìš”ì²­í•˜ê³  ìš´ì „ìê°€ ì£¼ë³€ìœ¼ë¡œ ìš”ì²­ëœ Rideë¥¼ í™•ì¸í•˜ëŠ” ê²ƒ ê¹Œì§€ í–ˆë‹¤. ì´ì œ ìš´ì „ìëŠ” ìš”ì²­ëœ Rideë¥¼ ìˆ˜ë½í•´ì•¼ í•œë‹¤.

- src/api/Ride/UpdateRideStatus/UpdateRideStatus.graphql

        type UpdateRideStatusResponse {
          ok: Boolean!
          error: String
        }
        
        enum StatusOptions {
          ACCEPTED
          FINISHED
          CANCELED
          REQUESTING
          ONROUTE
        }
        
        type Mutation {
          UpdateRideStatus(
            rideId: Int!, 
            status: StatusOptions!
          ): UpdateRideStatusResponse!
        }

- src/api/Ride/UpdateRideStatus/UpdateRideStatus.resolvers.ts

        import { UpdateRideStatusMutationArgs, UpdateRideStatusResponse } from "src/types/graph";
        import { Resolvers } from "src/types/resolvers";
        import Ride from "../../../entities/Ride";
        import User from "../../../entities/User";
        import privateResolver from "../../../utils/privateResolver";
        
        const resolvers: Resolvers = {
          Mutation: {
            UpdateRideStatus: privateResolver(
              async (
                _, 
                args: UpdateRideStatusMutationArgs, 
                { req }
              ) : Promise<UpdateRideStatusResponse> => {
                  const user: User = req.user;
                  if(user.isDriving) {
                    try {
                      let ride: Ride | undefined;
                      if(args.status === "ACCEPTED") {
                        ride = await Ride.findOne({
                          id: args.rideId,
                          status: "REQUESTING"
                        });
                        if(ride) {
                          ride.driver = user;
                          user.isTaken = true;
                          user.save();
                        }
                      } else {
                        ride = await Ride.findOne({
                          id: args.rideId,
                          driver: user
                        });
                      }
                      if(ride) {
                        ride.status = args.status
                        ride.save();
                        return {
                          ok: true,
                          error: null
                        }
                      } else {
                        return {
                          ok: false,
                          error: "Can't found Ride"
                        }
                      }
                    } catch(error) {
                      return {
                        ok: false,
                        error: error.message
                      }
                    }
                  } else {
                    return {
                      ok: false,
                      error: "User is Not on driving"
                    }
                  }
              }
            )
          }
        }
        
        export default resolvers;

ì¼ë‹¨ ëŒ€ëµì ì¸ ë¼ˆëŒ€ë¥¼ ë§Œë“¤ì—ˆì§€ë§Œ, ì—¬ê¸°ì„œëŠ” í•´ì•¼í•  ì¼ì´ ë§ë‹¤. ìˆ˜ë½í•˜ê³  Ride ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸ í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

## #1.77 UpdateRideStatus Resolver part Two

ìš´ì „ìëŠ” Rideì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ í•œë‹¤. (ìˆ˜ë½, ì¢…ë£Œ, ì·¨ì†Œ ë“±)

ì²˜ìŒì— RideëŠ” Requesting ìƒíƒœë¡œ ì‹œì‘í•˜ê³ , ìš´ì „ìê°€ ìŠ¹ì¸í•˜ë©´ Accepted ìƒíƒœë¡œ ëœë‹¤. ìŠ¹ì¸ë˜ì–´ì•¼ë§Œ RideëŠ” driverë¡œ ìŠ¹ì¸í•œ ìš´ì „ìë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤.

- src/api/Ride/UpdateRideStatus/UpdateRideStatus.resolvers.ts

        import { UpdateRideStatusMutationArgs, UpdateRideStatusResponse } from "src/types/graph";
        import { Resolvers } from "src/types/resolvers";
        import Ride from "../../../entities/Ride";
        import User from "../../../entities/User";
        import privateResolver from "../../../utils/privateResolver";
        
        const resolvers: Resolvers = {
          Mutation: {
            UpdateRideStatus: privateResolver(
              async (
                _, 
                args: UpdateRideStatusMutationArgs, 
                { req }
              ) : Promise<UpdateRideStatusResponse> => {
                  const user: User = req.user;
                  if(user.isDriving) {
                    try {
                      let ride: Ride | undefined;
                      if(args.status === "ACCEPTED") {
                        ride = await Ride.findOne({
                          id: args.rideId,
                          status: "REQUESTING"
                        });
                        if(ride) {
                          ride.driver = user;
                          user.isTaken = true;
                          user.save();
                        }
                      } else {
                        ride = await Ride.findOne({
                          id: args.rideId,
                          driver: user
                        });
                      }
                      if(ride) {
                        ride.status = args.status
                        ride.save();
                        return {
                          ok: true,
                          error: null
                        }
                      } else {
                        return {
                          ok: false,
                          error: "Can't found Ride"
                        }
                      }
                    } catch(error) {
                      return {
                        ok: false,
                        error: error.message
                      }
                    }
                  } else {
                    return {
                      ok: false,
                      error: "User is Not on driving"
                    }
                  }
              }
            )
          }
        }
        
        export default resolvers;

## #1.78 GetRide Resolver

ì´ë²ˆì—ëŠ” Rideê°’ì„ ê°€ì ¸ì˜¤ëŠ” ê°„ë‹¨í•œ ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ë³´ì. ì €ë²ˆì— í•œë²ˆ ì„¤ëª…í–ˆëŠ”ë°, ìš°ë¦¬ëŠ” ride entityì—ì„œ passengerì˜ user.idì™€ driverì˜ user.idê°€ í•„ìš”í•˜ë‹¤. ì´ëŸ¬í•œ ë‚´ìš©ì„ typeormì—ì„œ ì°¾ì„ ë•Œ relations ì˜µì…˜ ê°ì²´ë¥¼ ë„˜ê¸°ë©´ ë˜ì§€ë§Œ, ì´ë ‡ê²Œ ë˜ë©´ ë””ë¹„ ì„±ëŠ¥ì„ ì¡°ê¸ˆ ë” ì“°ê²Œ ëœë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— `passengerId`ì™€ `driverId`ë¥¼ ë³„ë„ì˜ í•„ë“œë¡œ ì¶”ê°€í•˜ì.

- src/api/Ride/shared/Ride.graphql

        ...
          driver: User!
          driverId: Int
          passenger: User!
          passengerId: Int
        ...

- src/entities/Ride.ts

        ...
        	@ManyToOne(type => User, user => user.ridesAsPassenger)
          passenger: User;
        
          @Column({nullable: true})
          passengerId: number;
        
          @ManyToOne(type => User, user => user.ridesAsDriver, { nullable: true })
          driver: User;
        
          @Column({nullable: true})
          driverId: number;
        ...

- src/api/Ride/GetRide./GetRide.graphql

        type GetRideResponse {
          ok: Boolean!
          error: String
          ride: Ride
        }
        
        type Query {
          GetRide(rideId: Int!): GetRideResponse!
        }

- src/api/Ride/GetRide/GetRide.resolvers.ts

        import { GetRideQueryArgs, GetRideResponse } from "src/types/graph";
        import { Resolvers } from "src/types/resolvers";
        import Ride from "../../../entities/Ride";
        import User from "../../../entities/User";
        import privateResolver from "../../../utils/privateResolver";
        
        const resolvers: Resolvers = {
          Query : {
            GetRide: privateResolver(async (
              _,
              args: GetRideQueryArgs,
              { req }
            ) : Promise<GetRideResponse> => {
              const user: User = req.user;
              try {
                const ride = await Ride.findOne({
                  id: args.rideId
                });
                if(ride) {
                  if(ride.passengerId === user.id || ride.driver.id === user.id) {
                    return {
                      ok: true,
                      error: null,
                      ride
                    };
                  } else {
                    return {
                      ok: false,
                      error: "Not Authorized",
                      ride: null
                    };
                  }
                } else {
                  return {
                    ok: false,
                    error: "Ride not found",
                    ride: null
                  }
                }
              } catch (error) {
                return {
                  ok: false,
                  error: error.message,
                  ride: null
                }
              }
            })
          }
        }
        
        export default resolvers;

rideIdë¥¼ í†µí•´ Rideê°’ì„ ê°€ì ¸ì˜¤ëŠ”ë°, ì•„ë¬´ë‚˜ ì ‘ê·¼í•˜ë©´ ì•ˆë˜ë‹ˆê¹Œ ë“œë¼ì´ë²„ë‚˜ ìŠ¹ê°ìœ¼ë¡œ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤.

ì•„ë˜ì„œ ì‘ì„±í•œ ì¿¼ë¦¬ë¥¼ í™•ì¸í•˜ì. rideIdëŠ” RequestRide ì—ì„œ ì–»ì€ idë¥¼ ë„£ì. (ì˜ ëª¨ë¥´ê² ë‹¤ë©´  1ë¶€í„° ê°’ì„ ë„£ì–´ë³´ë©´...) headerì—ëŠ” íƒ‘ìŠ¹ìì˜ tokenì„ ë„£ì.

    query {
      GetRide(rideId: 9) {
        ok
        error
        ride {
          status
        }
      }
    }

ì•„ë˜ ìš”ì²­ì€ `RUQUESTING` ìƒíƒœì¸ statusë¥¼ `ACCEPTED`ë¡œ ë°”ê¾¼ë‹¤.

    mutation {
      UpdateRideStatus(rideId:9, status: ACCEPTED) {
        ok
        error
      }
    }

GetRideë¥¼ ë‹¤ì‹œ ìš”ì²­í•˜ë©´ ë°”ë€Œì—ˆì„ ê²ƒì´ë‹¤.

## #1.79 RideStatusSubscription

ìœ ì €ê°€ Ride ìš”ì²­ì„ ë³´ë‚´ë©´ ì—¬ëŸ¬ ìš´ì „ìê°€ Rideìš”ì²­ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  ëˆ„êµ°ê°€ê°€ ìŠ¹ì¸í•˜ë©´, ë‹¤ë¥¸ ëª¨ë“  ìš´ì „ìì—ê²Œë„ ê·¸ ìš”ì²­ì´ ìŠ¹ì¸ë˜ì–´ì„œ ë³´ì´ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ í˜•íƒœë¡œ ì•Œìˆ˜ ìˆì–´ì•¼ í•œë‹¤. Rideì˜ ìƒíƒœë¥¼ êµ¬ë…í•˜ëŠ” Subscriptionì„ ë§Œë“¤ì.

- src/api/Ride/RideStatusSubscription/RideStatusSubscription.graphql

        interface Subscription {
          RideStatusSubscription: Ride
        }

- src/api/Ride/RideStatusSubscription/RideStatusSubscription.resolvers.ts

        import { withFilter } from "graphql-yoga";
        import User from "../../../entities/User";
        
        const resolvers = {
          Subscription: {
            RideStatusSubscription: {
              subscribe: withFilter(
                (_, __, { pubSub }) => pubSub.asyncIterator("rideUpdate"),
                (payload, _, context ) => {
                  const user: User = context.currentUser;
                  const {
                    RideStatusSubscription: { drvierId, passengerId }
                  } = payload;
                  return user.id === drvierId || user.id === passengerId;
                }
              )
            }
          }
        }
        
        export default resolvers;

    `rideUpdate` ì±„ë„ë¡œ ë°ì´í„°ë¥¼ êµ¬ë…í•œë‹¤. 

`rideUpdate`ì±„ë„ì— ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸í•  ë•Œ ë°ì´í„°ë¥¼ ë„£ì–´ì£¼ì.

- src/api/Ride/UpdateRideStatus/UpdateRideStatus.resolvers.ts

        ...
                { req, pubSub }
              ) : Promise<UpdateRideStatusResponse> => {
                ...
                      if(ride) {
                        ride.status = args.status
                        ride.save();
                        pubSub.publish("rideUpdate", { RideStatusSubscription: ride });
                        return {
                          ok: true,
                          error: null
                        }
        ...

ë‹¤ ì˜ ë§ˆë¬´ë¦¬ ë˜ì—ˆë‹¤.

## #1.80 Testing the RideStatusSubscription

ì´ë²ˆì—ëŠ” êµ¬ë…ì„ ì˜í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ì.

[http://localhost:5500/playground](http://localhost:4000/playground) ì— ì ‘ì†í•´ì„œ êµ¬ë…ì„ í•˜ì. í—¤ë”ì—ëŠ” íƒ‘ìŠ¹ìì˜ tokenì„ í¬í•¨ì‹œí‚¤ì.

    subscription {
      RideStatusSubscription {
        status
      }
    }

ê·¸ë¦¬ê³  ìš´ì „ìì˜ tokenìœ¼ë¡œ UpdateRideStatusë¡œ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ ë°”ë€Œë©´ êµ¬ë…í•œ ê³³ì—ì„œ ê°’ì„ ì½ì–´ ë“¤ì¼ ê²ƒì´ë‹¤.