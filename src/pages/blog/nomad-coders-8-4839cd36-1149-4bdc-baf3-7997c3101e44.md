---
templateKey: blog-post
title: ğŸš• 8 ìš°ë²„ í´ë¡  ì½”ë”© (nomad coders)
date: 2019-04-22T08:56:56.243Z
description: ìš°ë²„ ì½”ë”© ê°•ì˜ ë¡œê·¸ 1.40 ~ 1.48
featuredpost: true
featuredimage: /img/nuber_clone.jpg
tags:
  - nomad coders
  - ìš°ë²„ í´ë¡  ì½”ë”©
---
# 

## #1.40 EmailSignUp Resolver

ì´ë©”ì¼ íšŒì› ê°€ì…ì„ í•˜ë„ë¡ í•˜ì. ë¡œì§ì€ ë¡œê·¸ì¸ ì²˜ëŸ¼ ê°„ë‹¨í•˜ë‹¤.

- src/api/User/EmailSignUp.graphql ìƒì„±í•´ì„œ Mutaionì„ ì‘ì„±í•˜ì

        type EmailSignUpResponse {
          ok: Boolean!
          error: String
          token: String
        }
        
        
        type Mutation {
          EmailSignUp(
            firstName: String!, 
            lastName: String!, 
            email: String!, 
            password: String!, 
            profilePhoto: String!, 
            age: Int!,
            phoneNumber: String!
          ): EmailSignUpResponse!
        }

- src/api/User/EmailSignUp.resolvers.ts ìƒì„±í•´ì„œ resolversë¥¼ ì‘ì„±í•˜ì.

        import { Resolvers } from "src/types/resolvers";
        import { EmailSignUpMutationArgs, EmailSignUpResponse } from "src/types/graph";
        import User from "../../../entities/User";
        
        const resolvers: Resolvers = {
          Mutation: {
            EmailSignUp: async (
              _, 
              args: EmailSignUpMutationArgs
            ): Promise<EmailSignUpResponse> => {
              try {
                const { email } = args;
                const existingUser = await User.findOne({ email });
                if(existingUser) {
                  return {
                    ok: false,
                    error: 'existing email. You should log in instead',
                    token: null
                  }
                } else {
                  const newUser = await User.create({ ...args });
                  return {
                    ok: true,
                    error: null,
                    token: 'comming soon'
                  }
                }
              } catch(error) {
                return {
                  ok: false,
                  error: error.message,
                  token: null
                }
              }
            }
          }
        
        }
        
        export default resolvers;

í•˜ë‹¤ ë³´ë‹ˆ graphql ì—ì„œ type, query, mutation ì‘ì„±ì€ ì–´ëŠì •ë„ ìµìˆ™í•´ì¡Œë‹¤. ë‹¤ìŒ ë²ˆì—” í† í° ë°œê¸‰ì„ ì§ì ‘ í•´ë³¼ ì°¨ë¡€ë‹¤.

## #1.41 Creating Custom JWT

- JWT(json web token)ì„ ì„¤ì¹˜í•˜ì. ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ì„ í† í°ìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë‹¤.

        $ yarn add jsonwebtoken
        $ yarn add @types/jsonwebtoken --dev

í† í°ì„ ìƒì„±í•  ë•Œ ëˆ„êµ¬ë‚˜ ì•„ëŠ” ê°’ ì™¸ì— ë‚˜ë§Œ ì•„ëŠ” ê°’ì„ ì¶”ê°€ì ìœ¼ë¡œ ë„£ì–´ì„œ ë³´ì™„ì„ ê°•í™”í•´ì•¼ í•œë‹¤.

- src/.env ì— JWT_TOKENë¥¼ ì¶”ê°€í•˜ì.

        ...
        JWT_TOKEN=2bCxgznKS?mvgR&GKU%mcz-cA4EMS&s3%U4eurGjB^YxU&WvMu#

- src/utils/createJWT.ts íŒŒì¼ì— jwtë¥¼ ìƒì„±í•˜ëŠ” `createJWT`ë¥¼ ì •ì˜í•˜ì.

        import jwt from 'jsonwebtoken';
        
        const createJWT = (id: number): string => {
          const token = jwt.sign(
            {
              id
            },
        		process.env.JWT_TOKEN || ""
          );
          return token;
        };
        
        export default createJWT;

ìœ„ì—ì„œ ë‚´ê°€ ìƒì„±í•œ ì„ì˜ì˜ ê°’ì„ ì¶”ê°€ í–ˆì§€ë§Œ, ì‹¤ì œë¡œ ì„œë¹„ìŠ¤ë¥¼ í•  ë•ŒëŠ” ëœë¤í•œ ê°’ì„ ì„ì˜ë¡œ ìƒì„±í•´ì¤˜ì•¼ í•œë‹¤.

[https://passwordsgenerator.net/](https://passwordsgenerator.net/) ì— ë“¤ì–´ê°€ì„œ ì•„ë˜ ì²˜ëŸ¼ ì²´í¬ í•œ í›„ ìƒì„± ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì„ì˜ì˜ ê°’ì„ ìƒì„±í•´ì¤€ë‹¤.

![](_2019-04-19__2-039a4319-ffce-40c8-bc3b-ecb38d37d384.57.39.png)

## #1.42 Authenticating Users with Custom JWT

ì´ì œ ìœ í‹¸ì— ì •ì˜ëœ `createJWT` ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒì„±í•œ í† í°ì„ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬í•˜ë„ë¡ í•  ê²ƒì´ë‹¤.

- src/api/User/CompletePhoneVerification/CompletePhoneVerification.resolvers.ts

        ...
        import createJWT from "../../../utils/createJWT";
        import User from "../../../entities/User";
        
        ...
              try {
                const user = await User.findOne({ phoneNumber });
                if(user) {
                  user.verifiedPhoneNumber = true;
                  user.save();
                  const token = createJWT(user.id);
                  return {
                    ok: true,
                    error: null,
                    token
                  }
        ...

- src/api/User/EmailSignIn/EmailSignIn.resolvers.ts

        ...
        import createJWT from "../../../utils/createJWT";
        import User from "../../../entities/User";
        
        ...
                const token = createJWT(user.id);
                if(checkPassword) {
                  return {
                    ok: true,
                    error: null,
                    token
                  }
        ...

- src/api/User/EmailSignUp/EmailSignUp.resolvers.ts

        ...
        import createJWT from "../../../utils/createJWT";
        import User from "../../../entities/User";
        
        ...
                  const newUser = await User.create({ ...args }).save();
                  const token = createJWT(newUser.id);
                  return {
                    ok: true,
                    error: null,
                    token: token
                  }
                }
        ...

- src/api/User/FacebookConnect/FacebookConnect.resolvers.ts

        ...
        import createJWT from "../../../utils/createJWT";
        import User from '../../../entities/User';
        
        ...
                const exitingUser = await User.findOne({ fbId });
                if(exitingUser) {
                  const token = createJWT(exitingUser.id);
                  return {
                    ok: true,
                    error: null,
                    token
                  }
                }
        ...
        			try {
                const user = await User.create({
                  ...args,
                  profilePhoto: `http://graph.facebook.com/${fbId}/picture?type=square'`
                }).save();
                const token = createJWT(user.id);
                return {
                  ok: true,
                  error: null,
                  token
                }
        ...

ì´ì œ ë‹¤ì‹œ ì•„ë˜ì˜ ì¿¼ë¦¬ë¥¼ ìš”ì²­í•´ë³´ì. ì´ë²ˆì—ëŠ” ì •ìƒì ìœ¼ë¡œ tokenì„ ì£¼ëŠ” ê²ƒì„ í™•ì¸í•˜ ìˆ˜ ìˆë‹¤.
http://localhost:4000/playground

    mutation {
      FacebookConnect(firstName: "TaeMin", lastName:"Moon", fbId: "2131321321", email: "test@gmail.com") {
        ok
        error
        token
      }
    }

## #1.43 Testing Authentication Resolvers

ì´ë²ˆì—ëŠ” ì§€ê¸ˆê¹Œì§€ ì‘ì„±í•œ Queryì™€ Mutationì´ ì˜ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•´ë³¼ ì°¨ë¡€ë‹¤.

ì•„ë˜ëŠ” í˜„ì¬ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ë¡œ ë¡œê·¸ì¸ í–ˆì„ ë•Œë‹¤.

    mutation {
      EmailSignIn(email: "test5@gmail.com", password: "12345") {
        ok
        error
        token
      }
    }

![](_2019-04-19__3-d7f7bdaf-211e-4289-874d-2df494304085.36.18.png)

ì´ë²ˆì—” íšŒì› ê°€ì…ì„ í•˜ì. íšŒì› ê°€ì…ì„ ì„±ê³µí•˜ë©´ í† í°ì„ í•¨ê»˜ ì¤€ë‹¤.

    mutation {
      EmailSignUp(firstName: "test", lastName: "tamm", email: "test5@gmail.com", password: "12345", profilePhoto: "", age: 30, phoneNumber: "+82-1022307516") {
        ok
        error
        token
      }
    }

ë‹¤ì‹œ signInì„ ìš”ì²­í•˜ë©´ ì´ì œëŠ” ì •ìƒì ìœ¼ë¡œ í† í°ì„ ì¤€ë‹¤.

## #1.44 Custom Auth Middleware on Express part One

## #1.44 Custom Auth Middleware on Express part Two

í† í°ì„ ë°œê¸‰í•˜ë©´ í† í°ì„ í†µí•´ ì¸ì¦í•´ì•¼ í•œë‹¤. ì‚¬ìš©ìê°€ ìì‹ ì´ ë°›ì€ í† í°ì„ í†µí•´ ì¸ì¦ ì •ë³´ë¥¼ ì„œë²„ì—ê²Œ ì£¼ëŠ”ë°, ì„œë²„ëŠ” ë§¤ë²ˆ ì´ ì¸ì¦ ì •ë³´ë¥¼ í™•ì¸í•´ì•¼ í•œë‹¤. (httpëŠ” statelessí•˜ë‹ˆê¹Œ)

ì–´ë–¤ êµ¬ê°„ì—ì„œ ë§¤ë²ˆ í•˜ëŠ” ë™ì‘ì„ ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì²˜ë¦¬í•˜ê²Œ í•˜ë©´ ëœë‹¤. ê·¸ë˜ì„œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ ê±°ë‹¤.

- src/utils/decodeJWT.ts íŒŒì¼ì„ ìƒì„±í•˜ì—¬ í† í°ì„ ë””ì½”ë”©í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“ ë‹¤. ì–´ë–¤ ê°’ì„ ê°€ì§€ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ consoleì„ ì°ë„ë¡ í–ˆë‹¤.

        import jwt from 'jsonwebtoken';
        import User from '../entities/User';
        
        const decodeJWT = async (token: string) : Promise<User | undefined> => {
          try {
            const decoded : any = jwt.verify(token, process.env.JWT_TOKEN || "");
            const { id } = decoded;
            const user = await User.findOne({ id });
            return user;
          } catch(error) {
            return undefined;
          }
        }
        
        export default decodeJWT;

- src/app.ts ì— ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ì„œ ìœ„ì—ì„œ ì •ì˜í•œ ë””ì½”ë”© í•¨ìˆ˜ë¥¼ ë™ì‘ì‹œí‚¤ì. ì¼ë‹¨ ë‹¤ìŒ ì²˜ëŸ¼

        ...
        import decodeJWT from './utils/decodeJWT';
        import schema from './schema';
        ...
        
          private middlewares = (): void => {
            this.app.express.use(cors());
            this.app.express.use(logger('dev'));
            this.app.express.use(helmet());
            this.app.express.use(this.jwt);
          };
        	
        	private jwt = async (req, res, next) : Promise<void> => {
            const token = req.get("X-JWT");
            if(token) {
              const user = await decodeJWT(token);
              console.log(user);
            }
            next();
          }
        }
        
        export default new App().app;

ì •ìƒì ìœ¼ë¡œ ë¯¸ë“¤ì›¨ì–´ë¥¼ íƒ€ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ í—¤ë”ì— í† í°ì„ í¬í•¨í•˜ì—¬ ìš”ì²­í•´ë³´ì.

    query {
      user {
        id
      }
    }
    

![](_2019-04-20__12-8c2db49d-9c13-41e2-9e18-e01437fb275b.40.21.png)

í† í° ê°’ì€ ë°›ì€ SignInì´ë‚˜ ì´ëŸ° ìš”ì²­í•´ì„œ ë°›ì€ ê°’ìœ¼ë¡œ í•˜ì.

    {"X-JWT":"í† í°ê°’"}

![](_2019-04-20__12-4fba01dc-444b-4d0b-8d97-0eb60b09ba86.42.21.png)

## #1.46 Using Resolver Context for Authentication

ìœ„ì—ì„œ ë¯¸ë“¤ì›¨ì–´ì—ì„œëŠ” ìœ ì €ê°€ í—¤ë”ì— í¬í•¨ ì‹œí‚¨ ê°’ì„ í†µí•´ ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì™”ë‹¤. ì´ë ‡ê²Œ ê°€ì ¸ì˜¨ ìœ ì € ì •ë³´ë¥¼ ê° ìš”ì²­ì˜ resolversì— ì „ë‹¬í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. ê²°ë¡  ë¶€í„° ë§í•˜ìë©´ ìš°ë¦¬ëŠ” expressì˜ req ê°ì²´ì— user ê°ì²´ë¥¼ í¬í•¨ì‹œí‚¬ ê²ƒì´ë‹¤.

- src/app.ts

        import { NextFunction, Response } from 'express';
        import { GraphQLServer } from 'graphql-yoga';
        ...
        
        class App {
          public app: GraphQLServer;
        
          constructor() {
            this.app = new GraphQLServer({
              schema,
              context: req => {
                return {
                  req: req.request
                }
              }
            });
            this.middlewares();
          }
          
        	...
        
          private jwt = async (req, res: Response, next: NextFunction) : Promise<void> => {
            const token = req.get("X-JWT");
            if(token) {
              const user = await decodeJWT(token);
              req.user = user;
            }
            next();
          }
        }
        
        export default new App().app;

    ìœ„ ì½”ë“œë¥¼ ë³´ë©´ ë‘ ê°€ì§€ê°€ ì¶”ê°€ê°€ ë˜ì—ˆë‹¤. `decodeJWT`ë¡œ ì–»ì€ user ê°ì²´ë¥¼ req ê°ì²´ì— ë„£ì–´ì¤€ ê²ƒê³¼ `GraphQLServer` ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ context ë¥¼ ì¶”ê°€í•œ ê²ƒì´ë‹¤. ë¯¸ë“¤ì›¨ì–´ì—ì„œ req.user ì— ë„£ì€ userê°ì²´ë¥¼ contextì˜ ë¦¬í„´ê°’ìœ¼ë¡œ ì •ì˜ëœ  `req.request` ì—ì„œ userë¥¼ í¬í•¨í•˜ê²Œ ëœë‹¤. ê·¸ë¦¬ê³  contextëŠ” ê° resolversì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤.

     ì„ì‹œ ì½”ë“œë¥¼ ì‘ì„±í•´ì„œ ë¯¸ë“¤ì›¨ì–´ì—ì„œë¶€í„° ê°’ì„ ì˜ ì „ë‹¬í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì.

    - src/api/User/FacebookConnect/FacebookConnect.resolvers.ts ì— ì„ì˜ì˜ ì¿¼ë¦¬ë¥¼ ì¶œë ¥í•˜ë„ë¡ í•´ë³´ì.

            ...
            
            const resolvers: Resolvers = {
              Query: {
                user: (parent, args, context) => {
                  console.log(context.req.user);
                  return "";
                }
              },
              Mutation: {
                FacebookConnect: async (
            ...

    ìœ„ì—ì„œ ì²˜ëŸ¼ í† í° ê°’ì„ í—¤ë”ì— ì¶”ê°€í•˜ì—¬ ì¿¼ë¦¬ë¥¼ ë‹¤ì‹œ ë‚ ë ¤ë³´ë©´ ì¿¼ë¦¬ ê²°ê³¼ëŠ” ì—ëŸ¬ë¥¼ ë‚´ì§€ë§Œ, vscodeì˜ ì½˜ì†”ì°½ì„ ì‚´í´ë³´ì. resolversì—ì„œ user ì •ë³´ë¥¼ ì˜ ì¶œë ¥í•˜ì˜€ë‹¤.

        query {
          user {
            id
          }
        }

    ì½˜ì†”ì— ì •ìƒì ìœ¼ë¡œ user ê°ì²´ê°€ ì¶œë ¥ë˜ëŠ”ì§€ í™•ì¸í•˜ì. í™•ì¸í•˜ì˜€ìœ¼ë©´ facebookConnect íŒŒì¼ì€ ì›ë³µì‹œí‚¤ì.

    > GraphQLServer ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ, contextë¥¼ í•¨ìˆ˜ë¡œ ì •ì˜í•˜ì˜€ëŠ”ë° ì¼ë°˜ ê°ì²´ë¡œ ì •ì˜í•  ìˆ˜ ìˆë‹¤. ì¼ë°˜ ê°ì²´ë¡œ ì •ì˜í•œë‹¤ë©´ í•­ìƒ ê°™ì€ contextë¥¼ ê°€ì§€ê²Œ ëœë‹¤. ì´ ê²½ìš° ê° ì‚¬ìš©ìë§ˆë‹¤ ì¸ì¦ ì •ë³´ê°€ ë°”ë€Œê¸° ë•Œë¬¸ì— í•´ë‹¹ ìš”ì²­ê±´ ë§ˆë‹¤ ë‹¤ë¥¸ contextë¥¼ ê°€ì ¸ì•¼ í•œë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì— ë¯¸ë“¤ì›¨ì–´ì—ì„œëŠ” request ê°ì²´ì— user ì •ë³´ë¥¼ ë„£ê³ , ê° resolversì—ì„œëŠ” contextì—ì„œ êº¼ë‚´ì˜¤ë„ë¡ í•œ ê²ƒì´ë‹¤.

## #1.47 GetMyProfile Resolver

## #1.48 Protecting Resolvers with Middlewares

ì´ë²ˆì—ëŠ” resolverì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì •ì˜í•  ê²ƒì´ë‹¤. ì˜ˆë¥¼ë“¤ë©´ ìœ ì €ê°€ ìì‹ ì˜ ì €ì¥ì†Œì˜ ë°ì´í„°ë¥¼ ìš”ì²­í–ˆì„ ë•Œ, ì „ì œëŠ” ìœ ì €ì— ëŒ€í•œ ì¸ì¦ì´ ë˜ì—ˆì„ ë•Œë§Œ ë°ì´í„°ë¥¼ ì¤˜ì•¼ í•œë‹¤. ê·¸ë ‡ë‹¤ë©´ resolverë§ˆë‹¤ ë§¤ë²ˆ ë¡œê·¸ì¸ ì²˜ë¦¬ë¥¼ ì •ì˜í•œë‹¤ë©´ êµ‰ì¥íˆ ê·€ì°®ì€ ì¼ì´ ë ê²ƒì´ë‹¤. ì—¬ê¸°ì„œëŠ” headerì—ì„œ JWT í† í°ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ìœ ì € ì •ë³´ê°€ ì—†ìœ¼ë©´ resolverì˜ ì¼ì„ í•˜ì§€ ì•Šê³ , ìœ ì € ì •ë³´ê°€ ìˆì„ ë•Œë§Œ ìš”ì²­í•œ ì¼ì„ ìˆ˜í–‰í•˜ë„ë¡ í•˜ê² ë‹¤.

- src/utils/privateResolver.ts ì„ ìƒì„±í•˜ì—¬ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì •ì˜í•œë‹¤.

        const privateResolver = resolverFunction => async (
          parent,
          args,
          context,
          info
        ) => {
          if (!context.req.user) {
            throw new Error('No JWT. I refuse to proceed');
          }
          const resolved = await resolverFunction(parent, args, context, info);
          return resolved;
        };
        
        export default privateResolver;

- src/api/User/GetMyProfile/GetMyProfile.graphql

        type GetMyProfileResponse {
          ok: Boolean!
          error: String
          user: User
        }
        
        type Query {
          GetMyProfile: GetMyProfileResponse!
        }

- src/api/User/GetMyProfile/GetMyProfile.resolvers.ts

        import { Resolvers } from "src/types/resolvers";
        import privateResolver from "../../../utils/privateResolver";
        
        const resolvers: Resolvers = {
          Query : {
            GetMyProfile: privateResolver(async (_, __, context) => {
              const { req: { user } } = context;
              return {
                ok: true,
                error: null,
                user
              }
            })
          }
        }
        
        export default resolvers;

ì´ì œ  [http://localhost:4000/playground](http://localhost:4000/playground) ì—ë“¤ì–´ê°€ì„œ ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ë³´ì. í—¤ë”ì— í† í°ì„ ë„£ì—ˆì„ ë•Œì™€ ì•ˆ ë„£ì—ˆì„ ë•Œ ì‘ë‹µì´ ì •ìƒì ìœ¼ë¡œ ì£¼ëŠ” ì§€ í™•ì¸í•˜ì.

    query {
      GetMyProfile {
        user {
          id
        }
      }
    }

ì§€ê¸ˆê¹Œì§€ ì‹¤ì œ í† í°ì„ í†µí•´ ì¸ì¦í•˜ëŠ” ì‘ì—…ì„ ì§„í–‰í•˜ì˜€ë‹¤.