---
templateKey: blog-post
title: ğŸš• 15 ìš°ë²„ í´ë¡  ì½”ë”© (nomad coders)
date: 2019-05-03T08:56:56.243Z
description: ìš°ë²„ ì½”ë”© ê°•ì˜ ë¡œê·¸ 1.81 ~ 1.87
featuredpost: true
featuredimage: /img/nuber_clone.jpg
tags:
  - nomad coders
  - ìš°ë²„ í´ë¡  ì½”ë”©
  - pubsub
  - graphql-yoga
---
# 

## #1.81 Creating a ChatRoom

ìŠ¹ê°ì´ Rideë¥¼ ìš”ì²­í•˜ê³ , ìš´ì „ìê°€ Rideë¥¼ ìˆ˜ë½í•˜ë©´ ì±„íŒ…ì´ ê°€ëŠ¥í•˜ê²Œ í•´ì•¼ í•œë‹¤. ì—¬ê¸°ì„œ ë‚´ê°€ ì˜ëª» ìƒê°í•œê²Œ ìˆì—ˆë‹¤. ì±„íŒ…ë°©ì´ ìƒì„±ë˜ë©´ ê±°ê¸°ì„œ ì—¬ëŸ¬ ìŠ¹ê°ì´ í•©ì„í–ˆì„ ë•Œ ë‹¤ ê°™ì´ ì±„íŒ…í•˜ëŠ” ì¤„ ì•Œì•˜ëŠ”ë°, ì—¬ê¸°ì„œëŠ” ìš´ì „ìì™€ Rideë¥¼ ìš”ì²­í•œ ìŠ¹ê°ì´ 1:1 ëŒ€í™”ë§Œ í•œë‹¤. ê·¸ë¦¬ê³  ì°¨ì— íƒ€ë©´ ì±„íŒ…ë°©ì€ ì‚¬ë¼ì§€ëŠ” ê²ƒ ê°™ë‹¤.

ë‹ˆì½œë¼ìŠ¤ë„ ì²˜ìŒì— ì—¬ëŸ¿ì´ ì±„íŒ…í•˜ëŠ” ê±¸ë¡œ entityêµ¬ì¡°ë¥¼ ì§ ê±° ê°™ì€ë° ë³´ë‹ˆê¹Œ, ì´ë²ˆì— ì¡°ê¸ˆ ìˆ˜ì •í•´ì„œ 1:1 ëŒ€í™” í˜•íƒœë¡œ ë§Œë“¤ì—ˆë‹¤. ê·¸ë ‡ê¸° ë–„ë¬¸ì— ì•„ë˜ì²˜ëŸ¼ entityë¥¼ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤.

- src/entities/Chat.ts ê¸°ì¡´ì— ìˆë˜ `participants` ë¥¼ `passenger`ì™€ `driver`ë¡œ êµ¬ë¶„í–ˆê³ , ë³„ë„ì˜ ê° id í•„ë“œ `passengerId`, `driverId`ë¥¼ ìƒì„±í–ˆë‹¤.

        import {
          BaseEntity,
          Column,
          CreateDateColumn,
          Entity,
          ManyToOne,
          OneToMany,
          PrimaryGeneratedColumn,
          UpdateDateColumn,
         } from 'typeorm'
        import Message from './Message';
        import User from './User';
        
        @Entity()
        class Chat extends BaseEntity {
          @PrimaryGeneratedColumn() id: number;
        
          @OneToMany(type => Message, message => message.chat)
          messages: Message[]
        
          @ManyToOne(type => User, user => user.chatsAsPassenger)
          passenger: User;
        
          @Column({nullable: true})
          passengerId: number;
        
          @ManyToOne(type => User, user => user.chatsAsDriver)
          driver: User;
        
          @Column({nullable: true})
          driverId: number;
        
          @CreateDateColumn() createAt: string;
          @UpdateDateColumn() updateAt: string;
        }
        
         export default Chat;

- src/entities/User.ts `chat` í•„ë“œë¥¼ `chatsAsPassenger`ì™€ `chatsAsDriver`ë¡œ êµ¬ë¶„í–ˆë‹¤.

        ...	
        	@Column({ type: "text"})
          profilePhoto: string;
        
          @OneToMany(type => Chat, chat => chat.passenger)
          chatsAsPassenger: Chat[];
        
          @OneToMany(type => Chat, chat => chat.driver)
          chatsAsDriver: Chat[];
        
          @OneToMany(type => Message, message => message.user)
          messages: Message[];
        ...

ë³€ê²½ëœ í•„ë“œì— ë”°ë¼ graphql íƒ€ì…ë„ ë³€ê²½í•˜ì.

- src/api/Chat/shared/Chat.graphql

        type Chat {
          id: Int!
          messages: [Message]!
          passenger: User!
          passengerId: Int!
          driver: User!
          driverId: Int!
          createAt: String!
          updateAt: String
        }

- src/api/User/shared/User.graphql `chat` í•„ë“œê°€ `chatsAsPassenger`, `chatsAsDriver`ë¡œ ë‚˜ë‰˜ì—ˆë‹¤.

        ...	
        	fullName: String
          chatsAsPassenger: [Chat]
          chatsAsDriver: [Chat]
          messages: [Message]
        ...

> ì—¬ê¸°ì„œ ê¶ê¸ˆí•œê²Œ ì™œ Chatì˜ ë¦¬ìŠ¤íŠ¸í˜•íƒœë¥¼ ê°–ëŠ”ì§€ë‹¤.  ì´ë ‡ê²Œ í•˜ë ¤ë©´ ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì„ ìˆ˜ë½í•´ì•¼ í•˜ëŠ”ê±´ë°,, ë™ì‹œì— ì—¬ëŸ¬ ì°¨ë¥¼ íƒˆê²ƒë„ ì•„ë‹ˆê³ ,,

- src/api/Ride/UpdateRideStatus/UpdateRideStatus.resolvers.ts ì—ì„œ ì±„íŒ…ì„ ìƒì„±ì‹œí‚¤ì.

        import { UpdateRideStatusMutationArgs, UpdateRideStatusResponse } from "src/types/graph";
        import { Resolvers } from "src/types/resolvers";
        import Chat from "../../../entities/Chat";
        import Ride from "../../../entities/Ride";
        
        ...
        
                      if(args.status === "ACCEPTED") {
                        ride = await Ride.findOne(
                          {
                            id: args.rideId,
                            status: "REQUESTING"
                          }, 
                          { relations: ["passenger"]}
                        );
                        if(ride) {
                          ride.driver = user;
                          user.isTaken = true;
                          user.save();
                          await Chat.create({
                            driver: user,
                            passenger: ride.passenger
                          }).save();
                        }
         ...

    ìš´ì „ìê°€ ìŠ¹ì¸ì„ í•˜ë©´ ì±„íŒ…ë°©ì´ ìƒì„±ë˜ëŠ”ë° ì´ë•Œ, ìš´ì „ìê°€ `driver`ë¡œ, `ride.passenger`ê°€ `chat.passenger` ê°€ ë˜ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— relations ì˜µì…˜ìœ¼ë¡œ `passenger` ì •ë³´ë¥¼ `ride`ì— í¬í•¨ì‹œí‚¤ê²Œ í–ˆë‹¤.

## #1.82 GetChat Resolver

GetChat Queryë¥¼ ì‘ì„±í•˜ì. ê·¸ëƒ¥ í•˜ë˜ë°ë¡œ ì‘ì„±í•˜ë©´ ëœë‹¤.

- src/api/Chat/GetChat.grpahql

        type GetChatResponse {
          ok: Boolean!
          error: String
          chat: Chat
        }
        
        type Query {
          GetChat(chatId: Int!): GetChatResponse! 
        }

- src/api/Chat/GetChat.resolvers.ts

        import { GetChatQueryArgs, GetChatResponse } from "src/types/graph";
        import { Resolvers } from "src/types/resolvers";
        import Chat from "../../../entities/Chat";
        import User from "../../../entities/User";
        import privateResolver from "../../../utils/privateResolver";
        
        const resolvers: Resolvers = {
          Query : {
            GetChat: privateResolver(async(
              _,
              args: GetChatQueryArgs,
              { req }
            ) :Promise<GetChatResponse> => {
              const user: User = req.user;
              try {
                const chat = await Chat.findOne({
                  id: args.chatId
                });
                if(chat) {
                  if(chat.driverId === user.id || chat.passengerId === user.id) {
                    return {
                      ok: true,
                      error: null,
                      chat
                    }
                  } else {
                    return {
                      ok: false,
                      error: "Not Authorized",
                      chat: null
                    }
                  }
                } else {
                  return {
                    ok: false,
                    error: "Chat Not found",
                    chat: null
                  }
                }
              } catch (error) {
                return {
                  ok: false,
                  error: error.message,
                  chat: null
                }
              }
            })
          }
        }
        
        export default resolvers;

    ìœ„ì— í–ˆë˜ ê²ƒì²˜ëŸ¼ chatIdë¡œ chat ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ê³ , ìš´ì „ì ë˜ëŠ” ìŠ¹ê°ì¼ ë•Œë§Œ ì •ìƒì ìœ¼ë¡œ ë¦¬í„´í•´ì¤€ë‹¤.

## #1.83 BugFixing

ë‹ˆì½œë¼ìŠ¤ê°€ ì§„í–‰í•˜ë©´ì„œ ë¹ ëœ¨ë¦°ê²Œ ìˆì–´ì„œ ê¸°ëŠ¥ ìˆ˜ì •ì„ í–ˆë‹¤. Rideê°€ ìƒì„±ë˜ë©´ ìš´ì „ìì™€ ìŠ¹ê°ì´ 1:1ë¡œ ì±„íŒ…ì„ í•  ìˆ˜ ìˆë„ë¡ ì±„íŒ… ê°ì²´ë¥¼ ìƒì„±í•´ì•¼ í•œë‹¤. ê·¸ë˜ì„œ Ride ì™€  Chatê°€ 1:1 ê´€ê³„ë¥¼ ê°€ì§€ë„ë¡ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

(ë‚´ê°€ ìœ„ì—ì„œ ì˜êµ¬ì‹¬ì„ ì œê¸°í•œ.. driver chatê³¼ passenger chat..ì€ ..?)

íƒ€ì…ì„ ìœ„ì²˜ëŸ¼ ì¡°ê¸ˆ ìˆ˜ì •í•˜ì.

- src/api/Chat/shared/Chat.graphql `ride`ì™€ `rideId`ë¥¼ ì¶”ê°€í•˜ì.

        ...
          driverId: Int!
          ride: Ride!
          rideId: Int
          createAt: String!
        ...

- src/api/Ride/shared/Ride.graphql `chat`ì™€ `chatId`ë¥¼ ì¶”ê°€í•˜ì.

        ..
          passengerId: Int
          chat: Chat
          chatId: Int
          distance: String!
        ...

- src/entities/Chat.ts `ride`ì™€ `rideId`ë¥¼ ì¶”ê°€í•˜ì.

        import {
          BaseEntity,
          Column,
          CreateDateColumn,
          Entity,
          ManyToOne,
          OneToMany,
          OneToOne,
          PrimaryGeneratedColumn,
          UpdateDateColumn,
         } from 'typeorm'
        import Message from './Message';
        import Ride from './Ride';
        import User from './User';
        
        ...
        
          @Column({nullable: true})
          driverId: number;
        
          @OneToOne(type => Ride, ride => ride.chat)
          ride: Ride;
        
          @Column({nullable: true})
          rideId: number;
        
          @CreateDateColumn() createAt: string;
          @UpdateDateColumn() updateAt: string;
        }
        
         export default Chat;

- src/entities/Ride.ts `chat`ì™€ `chatId`ë¥¼ ì¶”ê°€í•˜ì.

        import { rideStatus } from 'src/types/types';
        import {
          BaseEntity,
          Column,
          CreateDateColumn,
          Entity,
          JoinColumn,
          ManyToOne,
          OneToOne,
          PrimaryGeneratedColumn,
          UpdateDateColumn
         } from 'typeorm'
        import Chat from './Chat';
        import User from './User';
        
        ...
        
          @Column({nullable: true})
          driverId: number;
        
          @OneToOne(type => Chat, chat => chat.ride)
          @JoinColumn()
          chat: Chat;
        
          @Column({nullable: true})
          chatId: number;
        
          @CreateDateColumn() createAt: string;
          @UpdateDateColumn() updateAt: string;
        }
        
         export default Ride;

- src/api/Ride/RequestRide/RequestRide.resolvers.ts ì•„ë˜ ë‘ ì¤„ì„ ì¡°ê¸ˆ ìˆ˜ì •í•˜ì.

        ...
              if(!user.isRiding && !user.isDriving) {
        ...
                  error: "You can't request two rides or request a ride with driving",
        ...

- src/api/Ride/UpdateRideStatus/UpdateRideStatus.resolvers.ts ìš´ì „ìê°€ Ride ìŠ¹ì¸í•˜ë©´ chatë¥¼ ìƒì„±í•´ì„œ ride ì— ë„£ì–´ì¤˜ì•¼ í•œë‹¤.

        ...
                          const chat = await Chat.create({
                            driver: user,
                            passenger: ride.passenger
                          }).save();
                          ride.chat = chat;
                          ride.save();
                        }
        ...

## #1.84 Testing GetChat Resolver

ì±„íŒ… ê°ì²´ê°€ ì˜ ìƒì„±ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ì.

- src/api/Chat/GetChat/GetChat.resolvers.ts chat ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë–„ ê´€ê³„ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê²Œ ë³€ê²½í•˜ì.

        ...
                const chat = await Chat.findOne(
                  { id: args.chatId },
                  { relations: ["messages", "passenger", "driver"]}
                );
        ...

í…ŒìŠ¤íŠ¸ì— ì•ì„œ ë°ì´í„°ë¥¼ ì¡°ê¸ˆ ìˆ˜ì •í•´ì•¼ í•œë‹¤. pgAdmin 4 í”„ë¡œê·¸ë¨ìœ¼ë¡œ ìŠ¹ê° ìœ ì €ì˜ `isRiding`í•„ë“œë¥¼ falseë¡œ ë‘ê³ , ëª¨ë“  Ride ë ˆì½”ë“œë¥¼ ì§€ìš°ì.

ë‹¤ì‹œ ìŠ¹ê°ì€ RequestRide ë¥¼ ìš”ì²­í•˜ê³ , ìš´ì „ìëŠ” UpdateRideStatusë¡œ ACCEPTEDë¡œ ë§Œë“¤ì. ê·¸ëŸ¬ë©´ Chatê°€ ìƒì„±ë˜ì—ˆì„ ê²ƒì´ë‹¤. 

    query {
      GetRide(rideId: 10) { #rideIdëŠ” ì–»ì€ ê°’ìœ¼ë¡œ ë„£ì.
        ok
        error
        ride {
          pickUpLat
          pickUpLng
          status
          chatId
        }
      }
    }

chatIdë¥¼ ì–»ì—ˆë‹¤ë©´,, ì•„ë˜ë¥¼ ìš”ì²­í•˜ë©´ ë°ì´í„°ê°€ ì˜ ë‚˜ì˜¬ ê²ƒì´ë‹¤.

    query {
      GetChat(chatId: 1) {
        ok
        error
        chat {
          messages {
            text
          }
          passenger {
            fullName
          }
          driver {
            fullName
          }
        }
      }
    }

í…ŒìŠ¤íŠ¸ë¥¼ í–ˆë‹¤ë©´ ì•„ë˜ì²˜ëŸ¼ ë‹¤ì‹œ ë°”ê¿”ì£¼ì. chatì—ëŠ” messagesë§Œ í•„ìš”í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

- src/api/Chat/GetChat/GetChat.resolvers.ts chat ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë–„ ê´€ê³„ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê²Œ ë³€ê²½í•˜ì.

        ...
                const chat = await Chat.findOne(
                  { id: args.chatId },
                  { relations: ["messages"]}
                );
        ...

## #1.85 SendChatMessage Resolver

ì±„íŒ…ë°©ì€ ë§Œë“¤ì—ˆê³  ì´ì œ ì±„íŒ… ë©”ì‹œì§€ë¥¼ ë§Œë“¤ì–´ì„œ ì±„íŒ…ì„ í•´ì•¼ í•œë‹¤. ìœ„ì—ì„œ í–ˆë˜ ë‚´ìš©ê³¼ í¬ê²Œ ë‹¤ë¥´ì§€ ì•Šë‹¤.

- src/api/Chat/SendChatMessage/SendChatMessage.graphql

        type SendChatMessageResponse {
          ok: Boolean!
          error: String
          message: Message
        }
        
        type Mutation {
          SendChatMessage(chatId: Int!, text: String!): SendChatMessageResponse!
        }

- src/api/Chat/SendChatMessage/SendChatMessage.resolvers.ts

        import { SendChatMessageMutationArgs, SendChatMessageResponse } from "src/types/graph";
        import { Resolvers } from "src/types/resolvers";
        import Chat from "../../../entities/Chat";
        import Message from "../../../entities/Message";
        import User from "../../../entities/User";
        import privateResolver from "../../../utils/privateResolver";
        
        const resolvers: Resolvers = {
          Mutation : {
            SendChatMessage: privateResolver(async (
              _, 
              args: SendChatMessageMutationArgs, 
              { req }
            ) : Promise<SendChatMessageResponse> => {
              const user: User = req.user;
              try {
                const chat = await Chat.findOne({ id: args.chatId });
                if (chat) {
                  if(chat.driverId === user.id || chat.passengerId === user.id) {
                    const message = await Message.create({
                      text: args.text,
                      user,
                      chat
                    }).save();
                    return {
                      ok: true,
                      error: null,
                      message
                    };
                  } else {
                    return {
                      ok: false,
                      error: "Not Authorized",
                      message: null
                    };
                  }
                } else {
                  return {
                    ok: false,
                    error: "Chat not found",
                    message: null
                  };
                }
              } catch (error) {
                return {
                  ok: false,
                  error: error.message,
                  message: null
                };
              }
            })
          }
        };
        
        export default resolvers;

ì—¬ê¸°ê¹Œì§€ ì‘ì„±í–ˆë‹¤ë©´ í…ŒìŠ¤íŠ¸ë„ ë°”ë¡œ í•´ë³´ì. ë¨¼ì € í…ìŠ¤íŠ¸ë¥¼ ë³´ë‚´ê³ , GetChat í• ë•Œë„ ë©”ì‹œì§€ê°€ ì˜ ê°€ì ¸ì™€ì•¼ ëœë‹¤.

    mutation {
      SendChatMessage(chatId: 1, text: "i love it") {
        ok
        error
        message {
          text
        }
      }
    }

    query {
      GetChat(chatId: 1) {
        ok
        error
        chat {
          messages {
            text
          }
        }
      }
    }

## #1.86 MessageSubscription

ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ êµ¬ë…í•˜ì—¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆê²Œ í•˜ì. ë©”ì‹œì§€ typeì— chatId í•„ë“œë¥¼ ì¶”ê°€í•˜ì.

- src/api/Chat/shared/Message.graphql

        type Message {
          id: Int!
          text: String!
          chat: Chat!
          chatId: Int
          user: User!
          createAt: String!
          updateAt: String
        }

- src/entities/Message.ts

        ...
        
          @ManyToOne(type => Chat, chat => chat.messages)
          chat: Chat;
        
          @Column({nullable: true})
          chatId: number;
        
          @ManyToOne(type => User, user => user.messages)
          user: User;
        ...

- src/api/Chat/MessageSubscription/MessageSubscription.graphql

        type Subscription {
          MessageSubscription: Message
        }

- src/api/Chat/MessageSubscription/MessageSubscription.resolvers.ts

        import { withFilter } from "graphql-yoga";
        import Chat from "../../../entities/Chat";
        import User from "../../../entities/User";
        
        const resolvers = {
          Subscription: {
            MessageSubscription: {
              subscribe: withFilter(
                (_, __, { pubSub }) => pubSub.asyncIterator("newChatMessage"),
                async (payload, _, context ) => {
                  const user: User = context.currentUser;
                  const {
                    MessageSubscription: { chatId }
                  } = payload;
        
                  try {
                    const chat = await Chat.findOne({id: chatId});
                    if(chat) {
                      return chat.driverId === user.id || chat.passengerId === user.id;
                    } else {
                      return false;
                    }
                  } catch (error) {
                    return false;
                  }
                }
              )
            }
          }
        }
        
        export default resolvers;

ì•„ë˜ ì²˜ëŸ¼ êµ¬ë…í•œ í›„ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê²Œ ë˜ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

    subscription {
      MessageSubscription {
        user {
          fullName
        }
        text
        createAt
      }
    }

subscriptionì€ í•­ìƒ endpointë¥¼ /subscriptionìœ¼ë¡œ í•´ì•¼ í•œë‹¤.

![](_2019-05-03__10-bf8c4596-2c30-4e76-a309-54c11be5cd8d.52.48.png)

## #1.87 Backend Conclusions

typescript, graphql-yoga, postgresql, typedormì„ ì¨ì„œ ë°±ì—”ë“œ ë¶€ë¶„ì„ ì™„ì„±í–ˆë‹¤. í° ì„œë¹„ìŠ¤ì§€ë§Œ, ì½”ë“œë¥¼ ê¹”ë”í•˜ê³  ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ê²Œ ëœ ê²ƒ ê°™ë‹¤.