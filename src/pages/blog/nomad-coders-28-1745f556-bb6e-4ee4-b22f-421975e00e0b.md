---
templateKey: blog-post
title: 28 ìš°ë²„ í´ë¡  ì½”ë”© (nomad coders)
date: 2019-06-19T08:56:56.243Z
description: ìš°ë²„ ì½”ë”© ê°•ì˜ ë¡œê·¸ 2.51 ~ 2.53
featuredpost: true
featuredimage: /img/nuber_clone.jpg
tags:
  - uber-clone-coding
  - nomad-coders
  - apollo
  - graphql
---
#

## #2.51 Geocoding part One

handleDragEndì—ì„œ lat, lng, address ëª¨ë‘ ê°±ì‹ í•´ì£¼ëŠ”ë°, addressì˜ ê°’ì„ ë³„ë„ë¡œ ë¶„ë¦¬ë¥¼ í–ˆë‹¤.

- src/routes/FindAddress/FindAddressContainer.tsx   `reverseGeocodeAddress`ë¥¼ ì •ì˜í•˜ì—¬ addressë¥¼ ë³„ë¡œë„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ì—ˆê³ , ì²˜ìŒ í˜ì´ì§€ê°€ ë¡œë”©ë ë•Œ, ê·¸ë¦¬ê³  ë“œë˜ê·¸ ë  ë•Œ ë™ì‘í•˜ë„ë¡ ìˆ˜ì •í–ˆë‹¤.

        ...
        
          public handleGeoSuccess: PositionCallback = (position: Position) => {
            const {
              coords: { latitude, longitude }
            } = position;
            this.setState({
              lat: latitude,
              lng: longitude
            })
            this.loadMap(latitude, longitude);
            this.reverseGeocodeAddress(latitude, longitude);
          }
        
        ...
        
          public handleDragEnd = () => {
        		if (!this.map) { return };
            const newCenter = this.map!.getCenter();
            const lat = newCenter.lat();
            const lng = newCenter.lng();
            
            this.setState({
              lat,
              lng
            });
            this.reverseGeocodeAddress(lat, lng);
          }
        
        ...
        
          public reverseGeocodeAddress = async (lat: number, lng: number) => {
            const reversedAddress = await reverseGeoCode(lat, lng);
            if (reversedAddress !== false) {
              this.setState({
                address: reversedAddress
              })
            }
          }
        }
        
        export default FIndAddressContainer;

ì´ë²ˆì—ëŠ” google mapì— ì¥ì†Œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” apië¥¼ ì‚¬ìš©í•´ë³´ê² ë‹¤.

- src/lib/mapHelpers.ts    getCodeëŠ” ì£¼ì†Œë¥¼ ì…ë ¥í•˜ë©´ í•´ë‹¹ ì¥ì†Œì— ëŒ€í•œ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚´ ì¤€ë‹¤.

        ...
        
        export const getCode = async (address: string) => {
          const URL = `https://maps.googleapis.com/maps/api/geocode/json?address=${address}&key=${process.env.REACT_APP_GOOGLE_MAPS_API_KEY}`;
          const { data } = await axios(URL);
          console.log(data);
        };
        ...

- src/routes/FindAddress/FindAddressContainer.tsx   `getCode`ë¥¼ ì„í¬íŠ¸ í•˜ê³  `onInputBlur` í•  ë•Œ í˜¸ì¶œë˜ë„ë¡ í•˜ì.

        import { getCode, reverseGeoCode } from "../../lib/mapHelpers";
        
        ...
        
          public onInputBlur = () => {
            console.log("Address update!")
            const { address } = this.state;
            getCode(address);
          }
        
        ...

[http://localhost:3000/find-address](http://localhost:3000/find-address) ì—ì„œ ê²€ìƒ‰ì— Lotte world tower ë¥¼ ì…ë ¥ í›„ ì§€ë„ ì•„ë¬´ê³³ì„ í´ë¦­í•˜ì(blurí•˜ê¸° ìœ„í•´) ê·¸ëŸ¬ë©´ ìœ„ì¹˜ ì •ë³´ê°€ ì•„ë˜ì²˜ëŸ¼ ë³´ì¸ë‹¤.

![](_2019-05-23__1-40db6b95-b553-4810-bccc-2353f483cab9.08.40.png)

## #2.52 Geocoding part Two

ì´ë²ˆì—ëŠ” ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ë©´ í•´ë‹¹ ì¥ì†Œë¡œ ì´ë™ í•˜ê³  ì •í™•í•œ ì£¼ì†Œë¥¼ ë‚˜íƒ€ë‚˜ë„ë¡ í•˜ì.

- src/lib/mapHelpers.ts   `getCode` í•¨ìˆ˜ë¥¼ ì¡°ê¸ˆ ìˆ˜ì •í•˜ì. ê·¸ ì•ˆì— ë°ì´í„°ë¥¼ êº¼ë‚´ì„œ ë¦¬í„´í•œë‹¤.

        ...
        
        export const getCode = async (address: string) => {
          const URL = `https://maps.googleapis.com/maps/api/geocode/json?address=${address}&key=${process.env.REACT_APP_GOOGLE_MAPS_API_KEY}`;
          const { data } = await axios(URL);
          console.log(data);
        
          if(data.error_message) {
            toast.error(data.error_message);
            return false;
          } else {
            const { results } = data;
            const firstPlace = results[0];
            if(!firstPlace) {
              toast.error('No Place');
              return false;
            } else {
              const {
                formatted_address,
                geometry: {
                  location: { lat, lng }
                }
              } = firstPlace;
              return { formatted_address, lat, lng };
            }
          }
        };
        
        ...

- src/routes/FindAddress/FindAddressContainer.tsx   ì§€ë„ ë¡œë”©í•  ë•Œ ê²€ìƒ‰ì´ ì™„ë£Œë˜ë©´ `this.map.panTo`Â ë¡œ ì¥ì†Œë¡œ ì´ë™í•˜ë„ë¡ ì²˜ë¦¬í–ˆë‹¤.

        ...
              disableDefaultUI: true,
              zoom: 11
            } 
        ...
        
          public onInputBlur = async () => {
            if (!this.map) { return };
            const { address } = this.state;
            const result = await getCode(address);
            if (result !== false ) {
              const { lat, lng, formatted_address } = result;
              this.setState({
                address: formatted_address,
                lat,
                lng
              });
              this.map.panTo({ lat, lng });
            }
          }
        
        ...

[http://localhost:3000/find-address](http://localhost:3000/find-address) ì—ì„œ ê²€ìƒ‰ì— Lotte world tower ë¥¼ ì…ë ¥ í›„ ì§€ë„ ì•„ë¬´ê³³ì„ í´ë¦­í•˜ì(blurí•˜ê¸° ìœ„í•´) ê·¸ëŸ¬ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™ì´ ëœë‹¤.

## #2.53 Refactoring AddPlace

![](_2019-05-23__2-870e84dd-4a7d-46ad-b0d5-a505361e239e.35.23.png)

ì¥ì†Œë¥¼ ì¶”ê°€í•  ë•Œ, ì§€ë„ë¥¼ í†µí•´ì„œ ì¥ì†Œë¥¼ ì„ íƒí•˜ì—¬ ì¶”ê°€í•˜ë„ë¡ êµ¬í˜„ì„ í•´ì•¼ í•œë‹¤. ê·¸ë˜ì•¼ ì¥ì†Œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

- src/components/Button/Button.tsx   ì†ì„±ì— `className`ì„ ê°€ì§€ëŠ” ë²„íŠ¼ìœ¼ë¡œ ë°”ê¾¸ì.

        ...
        
        interface IProps {
          value: string;
          onClick: any;
          disabled?: boolean;
          className?: string;
        }
        
        const Button: React.SFC<IProps> = ({
          value,
          onClick,
          disabled = false,
          className
        }) => (
          <Container
            value={value}
            onClick={onClick}
            disabled={disabled}
            className={className}
            type="submit"
          />
        )
        
        
        export default Button;

- src/routes/FindAddress/FindAddressPresenter.tsx  ìœ„ì—ì„œ ë§Œë“  ë²„íŠ¼ì„ ì¶”ê°€í•˜ê³  `onPickPlace` ë¥¼ Containerë¡œ ë¶€í„° ë°›ì•„ì„œ ë²„íŠ¼ì˜ í•¸ë“¤ëŸ¬ë¡œ ì“°ì.

        import AddressBar from "components/AddressBar";
        import Button from "components/Button";
        import React from "react";
        import Helmet from "react-helmet";
        import styled from "../../typed-components";
        
        const ExtendedButton = styled(Button)`
          position: absolute;
          bottom: 50px;
          left: 0;
          right: 0;
          margin: auto;
          z-index: 10;
          height: auto;
          width: 80%;
        `;
        
        const Map = styled.div`
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 100%;
          z-index: 1;
        `;
        
        const CenterPoint = styled.div`
          position: absolute;
          width: 2rem;
          height: 2rem;
          z-index: 2;
          font-size: 2rem;
          margin: auto;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
        `;
        
        interface IProps {
          mapRef: any;
          address: string;
          onInputBlur: () => void;
          onPickPlace: () => void;
          onInputChange: React.ChangeEventHandler<HTMLInputElement>;
        }
        
        class FindAddressPresenter extends React.Component<IProps> {
          public render() {
            const { 
              mapRef, 
              address, 
              onInputChange, 
              onInputBlur,
              onPickPlace,
            } = this.props;
            return (
              <div>
                <Helmet>
                  <title>Find Address | Nuber</title>
                </Helmet>
                <ExtendedButton value="Pick this place" onClick={onPickPlace}/>
                <CenterPoint>ğŸ“</CenterPoint>
                <Map ref={mapRef}/>
                <AddressBar
                  onBlur={onInputBlur}
                  onChange={onInputChange}
                  value={address}
                  name="address"
                />
              </div>
            );
          }
        }
        
        export default FindAddressPresenter;

- src/routes/FIndAddress/FindAddressContainer.tsx    `onPickPlace`ì—ì„œ ì¥ì†Œë¥¼ ì •í•´ì§€ë©´ ì¥ì†Œ ì •ë³´ë¥¼ stateì— ë„£ê³  `/add-place`ë¡œ ì´ë™ì„ í•˜ë„ë¡ í–ˆë‹¤.

        import React from "react";
        import ReactDOM from "react-dom";
        import { RouteComponentProps } from "react-router-dom";
        import { getCode, reverseGeoCode } from "../../lib/mapHelpers";
        import FindAddressPresenter from "./FindAddressPresenter";
        
        interface IProps extends RouteComponentProps<any> {
          google: any;
        }
        
        interface IState {
          lat: number;
          lng: number;
          address: string;
        }
        
        class FIndAddressContainer extends React.Component<IProps, IState> {
          public mapRef: any;
          public map: google.maps.Map | null;
          public state ={
            address: "",
            lat: 0,
            lng: 0,
          }
        
          constructor(props) {
            super(props);
            this.mapRef = React.createRef();
            this.map = null;
          }
        
          public componentDidMount() {
            navigator.geolocation.getCurrentPosition(
              this.handleGeoSuccess,
              this.handleGeoError
            )
          }
        
          public render() {
            const { address } = this.state;
            return (
              <FindAddressPresenter 
                mapRef={this.mapRef}
                address={address}
                onInputChange={this.onInputChange}
                onInputBlur={this.onInputBlur}
                onPickPlace={this.onPickPlace}
              />
            );
          }
        
          public handleGeoSuccess: PositionCallback = (position: Position) => {
            const {
              coords: { latitude, longitude }
            } = position;
            this.setState({
              lat: latitude,
              lng: longitude
            })
            this.loadMap(latitude, longitude);
            this.reverseGeocodeAddress(latitude, longitude);
          }
        
          public handleGeoError: PositionErrorCallback = () => {
            console.error('No postion');
          }
        
          public loadMap = (lat, lng) => {
            const { google } = this.props;
            const maps = google.maps;
            const mapNode = ReactDOM.findDOMNode(this.mapRef.current);
            const mapConfig: google.maps.MapOptions = {
              center: {
                lat,
                lng
              },
              disableDefaultUI: true,
              zoom: 11
            } 
            this.map = new maps.Map(mapNode, mapConfig);
            this.map!.addListener("dragend", this.handleDragEnd);
          }
        
          public handleDragEnd = () => {
            if (!this.map) { return };
            const newCenter = this.map!.getCenter();
            const lat = newCenter.lat();
            const lng = newCenter.lng();
            
            this.setState({
              lat,
              lng
            });
            this.reverseGeocodeAddress(lat, lng);
          }
        
          public onInputChange: React.ChangeEventHandler<HTMLInputElement> = event => {
            const {
              target: { name, value }
            } = event;
            this.setState({
              [name]: value
            } as any);
          };
        
          public onInputBlur = async () => {
            if (!this.map) { return };
            const { address } = this.state;
            const result = await getCode(address);
            if (result !== false ) {
              const { lat, lng, formatted_address } = result;
              this.setState({
                address: formatted_address,
                lat,
                lng
              });
              this.map.panTo({ lat, lng });
            }
          }
        
          public onPickPlace = () => {
            const { address, lat, lng } = this.state;
            const { history } = this.props;
            history.push({
              pathname: "/add-place",
              state: {
                address,
                lat,
                lng
              }
            });
          }
        
          public reverseGeocodeAddress = async (lat: number, lng: number) => {
            const reversedAddress = await reverseGeoCode(lat, lng);
            if (reversedAddress !== false) {
              this.setState({
                address: reversedAddress
              })
            }
          }
        }
        
        export default FIndAddressContainer;

ì´ë™í•œ /add-place í˜ì´ì§€ì—ì„œëŠ” stateì—ì„œ ê°’ì„ êº¼ë‚´ì–´ ì…‹íŒ…ì„ í•´ì£¼ë©´ ëœë‹¤.

- src/routes/AddPlace/AddPlaceContainer.tsx  `validatePlace` ë¥¼ ì •ì˜í•´ì„œ ì¥ì†Œë¥¼ ì¶”ê°€í•  ë•Œ ì§€ë„ë¥¼ í†µí•´ì„œ ì¶”ê°€ í–ˆëŠ”ì§€ì— ëŒ€í•œ ê²€ì¦í•˜ë„ë¡ ë³€ê²½í–ˆë‹¤.

        import React from "react";
        import { Mutation } from "react-apollo";
        import { RouteComponentProps } from "react-router-dom";
        import { toast } from "react-toastify";
        import { GET_PLACES } from "../../sharedQueries.queries";
        import { addPlace, addPlaceVariables } from "../../types/api";
        import { ADD_PLACE } from "./AddPlace.queries";
        import AddPlacePresenter from "./AddPlacePresenter";
        
        interface IState {
          address: string;
          name: string;
          lat: number;
          lng: number;
        }
        
        interface IProps extends RouteComponentProps<any> {}
        
        class AddPlaceMutation extends Mutation<addPlace, addPlaceVariables> {}
        
        class AddPlaceContainer extends React.Component<IProps, IState> {
          constructor(props: IProps) {
            super(props);
            const { location: { state = {} } = {} } = props;
            this.state = {
              address: state.address || "",
              lat: state.lat || 0,
              lng: state.lng || 0,
              name: ""
            };
          }
        
          public render() {
            const { address, name, lat, lng } = this.state;
            const { history } = this.props;
            return (
              <AddPlaceMutation 
                mutation={ADD_PLACE}
                variables={{
                  address,
                  isFav: false,
                  lat,
                  lng,
                  name
                }}
                onCompleted={ data => {
                  const { AddPlace } = data;
                  if (AddPlace.ok) {
                    toast.success("Place added");
                    setTimeout(() => {
                      history.push("/places");
                    }, 2000);
                  } else {
                    toast.error(AddPlace.error);
                  }
                }}
                refetchQueries={[{query: GET_PLACES}]}
              >
                {(addPlaceMutaion, { loading }) => (
                  <AddPlacePresenter
                    onInputChange={this.onInputChange}
                    address={address}
                    name={name}
                    loading={loading}
                    onSubmit={() => this.validatePlace(addPlaceMutaion)}
                  />
                )}
              </AddPlaceMutation>
              
            )
          }
        
          public onInputChange: React.ChangeEventHandler<
            HTMLInputElement
          > = async event => {
            const {
              target: { name, value }
            } = event;
            this.setState({
              [name]: value
            } as any);
          }
        
          public validatePlace(mutation) {
            const { lat, lng } = this.state;
            if (lat === 0 && lng === 0) {
              toast.error("Invalid Position Info");
              return;
            }
            mutation();
          }
        }
        
        export default AddPlaceContainer;

- src/routes/AddPlace/AddPlacePresenter.tsx  `MutationFn`ìœ¼ë¡œ íƒ€ì… ì„ ì–¸í–ˆë˜ ê²ƒì„ ì œì™¸.

        import Button from "components/Button";
        import Form from "components/Form";
        import Header from "components/Header";
        import Input from "components/Input";
        import React from "react";
        import Helmet from "react-helmet";
        import { Link } from "react-router-dom";
        import styled from "../../typed-components";
        
        ...
        
        interface IProps {
          ...
        	onSubmit: () => void;
        }
        ...

ì´ì œ [http://localhost:3000/add-place](http://localhost:3000/add-place) ë¡œ ê°€ì. ì•„ê¹Œ ë„£ì—ˆë˜ stateê°€ ì§€ê¸ˆ í™”ë©´ì— í‘œì‹œ ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. (stateëŠ” ìƒˆë¡œê³ ì¹¨ì—ë„ ìœ ì§€ê°€ ëœë‹¤.)

ì„ì˜ë¡œ add placeì—ì„œ name, addressë¥¼ ì…ë ¥ í•œë‹¤ê³  í•´ë„ ì…ë ¥ì´ ì™„ì „íˆ ë˜ì§€ ì•Šê³ , pick place from mapì„ í†µí•´ì„œë§Œ ì¥ì†Œê°€ ì¶”ê°€ë˜ë„ë¡ ì‘ì—… í–ˆë‹¤.